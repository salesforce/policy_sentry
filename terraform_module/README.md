# Policy Sentry Terraform Module

Builds secure IAM Policies with resource constraints. For more information on Policy Sentry, see [the documentation](https://policy-sentry.readthedocs.io/en/latest/).

## Prerequisites

* You must have Policy Sentry 0.10.0 installed beforehand and it must be executable from your `$PATH`. Follow the installation instructions [here](https://policy-sentry.readthedocs.io/en/latest/user-guide/installation.html)
  * This module requires Terraform 0.12.8 or higher. It has been tested through 0.13.5.

## Usage

### Example

* Install Terraform 0.12.8

```bash
# tfenv is a Terraform version manager
brew install tfenv
tfenv install 0.12.8
```

* Install Policy Sentry

```bash
brew tap salesforce/policy_sentry https://github.com/salesforce/policy_sentry
brew install policy_sentry
```

* Use the module as shown in [main.tf](./demo/main.tf):

```hcl
module "policy_sentry_demo" {
  source                              = "github.com/salesforce/policy_sentry.git?ref=master//terraform_module/"
  name                                = var.name
  read_access_level                   = var.read_access_level
  write_access_level                  = var.write_access_level
  list_access_level                   = var.list_access_level
  tagging_access_level                = var.tagging_access_level
  permissions_management_access_level = var.permissions_management_access_level
  wildcard_only_single_actions               = var.wildcard_only_actions
  minimize                            = var.minimize
  skip_resource_constraints           = var.skip_resource_constraints
  exclude_actions                     = var.exclude_actions
}
```

Assuming you have your [variables.tf](./demo/variables.tf) file set properly (redacted from this README for readability), provide the following in your `terraform.tfvars` file.

* [terraform.tfvars](./demo/terraform.tfvars):

```hcl
name = "PolicySentryTest"

list_access_level = [
  "arn:aws:s3:::example-org",
]

read_access_level = [
  "arn:aws:kms:us-east-1:123456789012:key/shaq"
]

write_access_level = [
  "arn:aws:kms:us-east-1:123456789012:key/shaq"
]
```

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
## Requirements

| Name | Version |
|------|---------|
| terraform | >= 0.12.8 |
| aws | ~> 2.48.0 |
| external | ~> 1.2 |
| local | ~> 1.3 |
| null | ~> 2.1 |
| template | ~> 2.1.2 |

## Providers

No provider.

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| description | The description to include for the IAM policy. | `string` | `"Generated by Policy Sentry"` | no |
| exclude\_actions | Exclude actions from the output by specifying them here. Accepts wildcards, like kms:Delete\* | `list(string)` | `[]` | no |
| list\_access\_level | Provide a list of Amazon Resource Names (ARNs) that your role needs LIST access to. | `list(string)` | `[]` | no |
| minimize | If set to true, it will minimize the size of the IAM Policy file. Defaults to TRUE. | `bool` | `true` | no |
| name | The name of the rendered policy file (no file extension). | `string` | n/a | yes |
| permissions\_management\_access\_level | Provide a list of Amazon Resource Names (ARNs) that your role needs PERMISSIONS MANAGEMENT access to. | `list(string)` | `[]` | no |
| read\_access\_level | Provide a list of Amazon Resource Names (ARNs) that your role needs READ access to. | `list(string)` | `[]` | no |
| region | The AWS region for these resources. Defaults to us-east-1 | `string` | `"us-east-1"` | no |
| skip\_resource\_constraints | Skip resource constraint requirements by listing individual actions here, like s3:GetObject. | `list(string)` | `[]` | no |
| tagging\_access\_level | Provide a list of Amazon Resource Names (ARNs) that your role needs TAGGING access to. | `list(string)` | `[]` | no |
| wildcard\_only\_list\_service | To generate a list of AWS service actions that (1) are at the LIST access level and (2) do not support resource constraints, list the service prefix here. | `list(string)` | `[]` | no |
| wildcard\_only\_permissions\_management\_service | To generate a list of AWS service actions that (1) are at the PERMISSIONS MANAGEMENT access level and (2) do not support resource constraints, list the service prefix here. | `list(string)` | `[]` | no |
| wildcard\_only\_read\_service | To generate a list of AWS service actions that (1) are at the READ access level and (2) do not support resource constraints, list the service prefix here. | `list(string)` | `[]` | no |
| wildcard\_only\_single\_actions | Individual actions that do not support resource constraints. For example, s3:ListAllMyBuckets | `list(string)` | `[]` | no |
| wildcard\_only\_tagging\_service | To generate a list of AWS service actions that (1) are at the TAGGING access level and (2) do not support resource constraints, list the service prefix here. | `list(string)` | `[]` | no |
| wildcard\_only\_write\_service | To generate a list of AWS service actions that (1) are at the WRITE access level and (2) do not support resource constraints, list the service prefix here. | `list(string)` | `[]` | no |
| write\_access\_level | Provide a list of Amazon Resource Names (ARNs) that your role needs WRITE access to. | `list(string)` | `[]` | no |

## Outputs

| Name | Description |
|------|-------------|
| iam\_policy\_arn | The ARN assigned by AWS to this policy. |
| iam\_policy\_document | The policy document. |
| iam\_policy\_id | The policy's ID. |
| iam\_policy\_name | The name of the policy. |
| iam\_policy\_path | The path of the policy in IAM |

<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->

## Maintenance

* [Pre-commit hook](https://github.com/antonbabenko/pre-commit-terraform#4-run)

Run this every time before you push to Git.

```
pre-commit run -a
```


## Todo
* Publish this on Terraform module registry

